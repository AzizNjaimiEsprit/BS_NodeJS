{% include 'header.twig' %}

<!-- Start main Content -->
<style>
    .rate-star {
        width: 20px;
    }

    .rate-star2 {
        width: 30px;
    }
</style>
<input type="text" value="{{ book.bookId }}" hidden>
<div class="maincontent bg--white pt--80 pb--55">
    <div class="container">
        <div class="row">
            <div class="col-lg-9 col-12">
                <div class="wn__single__product">
                    <div class="row">
                        <div class="col-lg-6 col-12">
                            <a href="1.jpg"><img style="width: 325px;"
                                                 src="http://localhost:5000/book/getBookImage/{{ book.image }}" alt=""></a>
                        </div>
                        <div class="col-lg-6 col-12">
                            <div class="product__info__main">
                                <h1>{{ book.title }}</h1>
                                <div class="product-info-stock-sku d-flex">
                                    <p>Availability:<span> {{ book.quantity }}</span></p>
                                </div>
                                <div class="product-reviews-summary d-flex">
                                    <ul class="rating-summary d-flex">
                                        {% for i in 0..4 %}
                                            <div class="rate-star"><img class="bookRate"
                                                                        src="/images/png-img/blank.png"></div>
                                        {% endfor %}
                                        <input type="text" id="rate" hidden value="0">

                                    </ul>
                                </div>

                                <div class="price-box">
                                    <span>{{ book.price }} TND</span>
                                </div>
                                <div class="product__overview">
                                    <p>{{ book.summary }}</p>

                                </div>
                                <div class="box-tocart d-flex">
                                    <span>Qty</span>
                                    <input id="qty" class="input-text qty" name="qty" min="1" value="1" title="Qty"
                                           type="number">
                                    <div class="addtocart__actions">
                                        <button class="tocart" type="button" title="Add to Cart"
                                                onclick="addToCard({{ book.bookId }})">Add to Cart
                                        </button>
                                    </div>
                                </div>
                                <div class="product-addto-links clearfix" style="display: inline-flex">
                                    <p class="categories-title" style="margin-top: 8px;margin-right: 10px">Share: </p>
                                    <a class="wishlist" href="#"></a>
                                    <a class="compare" href="#"></a>
                                    <a class="email" href="#"></a>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="product__info__detailed">
                    <div class="pro_details_nav nav justify-content-start" role="tablist">
                        <a class="nav-item nav-link active" data-toggle="tab" href="#nav-details" role="tab">Details</a>
                        <a class="nav-item nav-link" data-toggle="tab" href="#nav-review" role="tab">Reviews</a>
                    </div>
                    <div class="tab__container">
                        <!-- Start Single Tab Content -->
                        <div class="pro__tab_label tab-pane fade show active" id="nav-details" role="tabpanel">
                            <div class="description__attribute">
                                <p>{{ book.summary }}</p>

                            </div>
                        </div>
                        <!-- End Single Tab Content -->
                        <!-- Start Single Tab Content -->
                        <div class="pro__tab_label tab-pane fade blog-details content" id="nav-review" role="tabpanel">
                            <div class="comments_area">
                                <h3 class="comment__title">Leave a Rate</h3>
                                <div style="padding-bottom: 50px">
                                    <div class="product-reviews-summary d-flex">
                                        <ul class="rating-summary d-flex">
                                            {% for i in 0..4 %}
                                                <div class="rate-star2"><img class="star"
                                                                             onclick="rateManagement({{ i }},{{ book.bookId }},4);"
                                                                             src="/images/png-img/blank.png"></div>
                                            {% endfor %}
                                            <input type="text" id="rate" hidden value="0">

                                        </ul>
                                    </div>
                                </div>

                                <h3 class="comment__title">{{ comments.length }} {{ comments.length <= 1 ? 'comment' : 'comments' }}</h3>
                                <ul class="comment__list">
                                    {% for comment in comments %}
                                        <li>
                                            <div class="wn__comment">
                                                <div class="thumb">
                                                    <img src="/images/blog/comment/1.jpeg" alt="comment images">
                                                </div>
                                                <div class="content">
                                                    <div class="comnt__author d-block d-sm-flex">
                                                        <span>{{ comment.full_name }}</span>
                                                    </div>
                                                    <p>{{ comment.text }}</p>
                                                </div>
                                            </div>
                                        </li>
                                    {% endfor %}

                                </ul>
                            </div>
                            <div class="comment_respond">
                                <h3 class="reply_title">Leave a Comment</h3>
                                <form class="comment__form" action="#">
                                    <div class="input__box">
                                        <label>Comment</label>
                                        <textarea id="commentBody" name="comment"></textarea>
                                    </div>

                                    <div class="submite__btn">
                                        <a onclick="addComment({{ book.bookId }})">Post Comment</a>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- End Single Tab Content -->
                    </div>
                </div>


            </div>
            <div class="col-lg-3 col-12 md-mt-40 sm-mt-40">
                <div class="shop__sidebar">
                    <aside class="wedget__categories poroduct--cat">
                        <h3 class="wedget__title">Product Categories</h3>
                        <ul>
                            {% for c in categories %}
                                <li><a href="#">{{ c.name }} <span>({{ c.count }})</span></a></li>
                            {% endfor %}
                        </ul>
                    </aside>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- End main Content -->
<!-- Start Search Popup -->
<div class="box-search-content search_active block-bg close__top">
    <form id="search_mini_form--2" class="minisearch" action="#">
        <div class="field__search">
            <input type="text" placeholder="Search entire store here...">
            <div class="action">
                <a href="#"><i class="zmdi zmdi-search"></i></a>
            </div>
        </div>
    </form>
    <div class="close__wrap">
        <span>close</span>
    </div>
</div>
<!-- End Search Popup -->
<!-- Start NEwsletter Area -->
<section class="wn__newsletter__area bg-image--2">
    <div class="container">
        <div class="row">
            <div class="col-lg-7 offset-lg-5 col-md-12 col-12 ptb--150">
                <div class="section__title text-center">
                    <h2>Stay With Us</h2>
                </div>
                <div class="newsletter__block text-center">
                    <p>Subscribe to our newsletters now and stay up-to-date with new collections, the latest lookbooks
                        and exclusive offers.</p>
                    <form action="#">
                        <div class="newsletter__box">
                            <input type="email" placeholder="Enter your e-mail">
                            <button>Subscribe</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    function setRate(index){
        let tab = document.getElementsByClassName("star")
        for (let i = 0; i <= index; i++) {
            tab[i].setAttribute('src', "/images/png-img/full.png");
        }
        for (let i = index + 1; i < tab.length; i++) {
            tab[i].setAttribute('src', "/images/png-img/blank.png");
        }
    }
    function addRate(index, bookId) {

        document.getElementById("rate").value = index + 1
        console.log(index + 1)
        $.ajax({
            type: "POST",
            url: "http://localhost:5000/bookRate/addRate",
            data: JSON.stringify({
                "userId": 4/*userId*/,
                "bookId": bookId,
                "rate": index + 1,
            }),
            contentType: "application/json",
            success: function (response) {
                console.log("Return of add book rate  = ", response)
                if (response == "ok")
                    alert("Rate added successfully")
            }
        });
        //element.setAttribute('src', "/images/png-img/full.png");
    }

    var currentUser = JSON.parse(sessionStorage.getItem("currentUser"));



    function addComment(bookId) {
        $.ajax({
            type: "POST",
            url: "http://localhost:5000/bookComment/addComment",
            data: JSON.stringify({
                "userId": 4/*userId*/,
                "bookId": bookId,
                "text": document.getElementById("commentBody").value,
            }),
            contentType: "application/json",
            success: function (response) {
                console.log("Return of add comment = ", response)
                if (response == "ok")
                    location.reload();
            }
        });
    }

    function loadRate(bookId) {
        $.get("http://localhost:5000/bookRate/getMoyenneRate/" + bookId, function (data, status) {
            console.log("Data: " + data + "\nStatus: " + status);
            let tab = document.getElementsByClassName("bookRate")
            for (let i = 0; i < Number(data); i++) {
                tab[i].setAttribute('src', "/images/png-img/full.png");
            }

        });
    }
    function loadRatePerUser(bookId,userId) {
        $.get("http://localhost:5000/bookRate/getListRatePerUser/" + bookId + "/" + userId, function (data, status) {
            console.log("Data: " + data + "\nStatus: " + status);
            let tab = document.getElementsByClassName("bookRate")
            for (let i = 0; i < Number(data); i++) {
                tab[i].setAttribute('src', "/images/png-img/full.png");
            }

        });
    }

    function updateRate(index, bookId) {
        $.ajax({
            type: "POST",
            url: "http://localhost:5000/bookRate/updateRate",
            data: JSON.stringify({
                "userId": 4/*userId*/,
                "bookId": bookId,
                "rate": index ,
            }),
            contentType: "application/json",
            success: function (response) {
                console.log("Return of add book rate  = ", response)
                if (response == "ok")
                    alert("Rate updated successfully")
            }
        });
    }

    function rateManagement(index, bookId, userId) {
        $.get("http://localhost:5000/bookRate/getListRatePerUser/" + bookId + "/" + userId, function (data, status) {
            console.log("Data 1: " + data + "\nStatus: " + status);

            if (Number(data) == 0) {
                addRate(index, bookId)
                setRate(index)
            } else {
                updateRate(index, bookId)
                setRate(index)

            }
        })
    }
    loadRate(document.getElementById("bookId"))
    loadRatePerUser(document.getElementById("bookId"))
</script>
<!-- End NEwsletter Area -->

{% include 'footer.twig' %}
